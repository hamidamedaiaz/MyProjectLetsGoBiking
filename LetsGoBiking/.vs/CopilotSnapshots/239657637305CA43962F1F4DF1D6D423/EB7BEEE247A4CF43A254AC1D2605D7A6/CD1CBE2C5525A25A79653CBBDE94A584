using System;
using System.Collections.Generic;
using System.Linq;
using System.ServiceModel;
using System.Runtime.Caching;  // ← Add this line
using ProxyCache.Models;

namespace ProxyCache.Services
{
    /// <summary>
    /// Implémentation du service ProxyCache
    /// Gère le cache et les appels à l'API JCDecaux
    /// </summary>
    [ServiceBehavior(InstanceContextMode = InstanceContextMode.Single)]
    public class ProxyCacheService : IProxyCache
    {
        private readonly MemoryCache _cache = MemoryCache.Default;
        private readonly JCDecauxService _jcDecauxService;
        private readonly TimeSpan _cacheExpiration = TimeSpan.FromMinutes(5);

        // ✅ Cache pour le mapping des contrats (rechargé toutes les heures)
        private Dictionary<string, string> _contractMapping;
        private DateTime _lastContractRefresh = DateTime.MinValue;
        private readonly TimeSpan _contractRefreshInterval = TimeSpan.FromHours(1);

        public ProxyCacheService()
        {
            _jcDecauxService = new JCDecauxService();
            RefreshContractMapping();
        }

        /// <summary>
        /// ✅ Rafraîchit le mapping des contrats depuis l'API JCDecaux
        /// </summary>
        private void RefreshContractMapping()
        {
            if (DateTime.Now - _lastContractRefresh < _contractRefreshInterval && _contractMapping != null)
            {
                return; // Pas besoin de rafraîchir
            }

            Console.WriteLine("🔄 Rafraîchissement du mapping des contrats...");

            try
            {
                _contractMapping = _jcDecauxService.GetAvailableContracts();
                _lastContractRefresh = DateTime.Now;
                
                Console.WriteLine($"✅ Mapping mis à jour avec {_contractMapping.Count} entrées");
                Console.WriteLine("📋 Exemples de villes supportées :");
                
                // Afficher quelques exemples
                var examples = _contractMapping.Take(10).Select(kvp => $"   - {kvp.Key} → {kvp.Value}");
                foreach (var example in examples)
                {
                    Console.WriteLine(example);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Erreur lors du rafraîchissement : {ex.Message}");
                
                // Fallback sur un mapping manuel si l'API échoue
                _contractMapping = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                {
                    { "Paris", "Paris" },
                    { "Lyon", "Lyon" },
                    { "Nice", "Cote_d_Azur" },
                    { "Marseille", "Marseille" },
                    { "Toulouse", "Toulouse" }
                };
                
                Console.WriteLine("⚠️ Utilisation du mapping de secours");
            }
        }

        /// <summary>
        /// Récupère les stations de vélos avec mise en cache
        /// </summary>
        public Models.BikeStation[] GetStations(string city)
        {
            Console.WriteLine($"📥 Requête reçue pour la ville : {city}");

            // ✅ Rafraîchir le mapping si nécessaire
            RefreshContractMapping();

            // ✅ Trouver le contrat correspondant
            string contract = _contractMapping.ContainsKey(city) 
                ? _contractMapping[city] 
                : city;

            if (contract != city)
            {
                Console.WriteLine($"🔄 Mapping : \"{city}\" → \"{contract}\"");
            }
            else if (!_contractMapping.ContainsKey(city))
            {
                Console.WriteLine($"⚠️ Ville '{city}' non trouvée dans le mapping, tentative avec le nom original...");
            }

            string cacheKey = $"JCDecaux-Stations-{contract}";

            // Vérifier le cache
            if (_cache.Contains(cacheKey))
            {
                Console.WriteLine($"💾 Cache HIT pour la clé : {cacheKey}");
                var cachedStations = _cache.Get(cacheKey) as Models.BikeStation[];
                Console.WriteLine($"✅ {cachedStations?.Length ?? 0} stations retournées");
                return cachedStations ?? new Models.BikeStation[0];
            }

            // Cache MISS
            Console.WriteLine($"🔄 Cache MISS pour la clé : {cacheKey}");

            try
            {
                var stations = _jcDecauxService.GetStations(contract);

                _cache.Add(cacheKey, stations, DateTimeOffset.Now.Add(_cacheExpiration));
                Console.WriteLine($"💾 Donnée mise en cache (expiration : {_cacheExpiration.TotalMinutes} min)");
                Console.WriteLine($"✅ {stations?.Length ?? 0} stations retournées");

                return stations ?? new Models.BikeStation[0];
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Erreur : {ex.Message}");
                return new Models.BikeStation[0];
            }
        }

        /// <summary>
        /// Vide le cache
        /// </summary>
        public bool ClearCache()
        {
            Console.WriteLine("🗑️ Nettoyage du cache...");
            
            var allKeys = _cache.Select(kvp => kvp.Key).ToList();
            
            foreach (var key in allKeys)
            {
                _cache.Remove(key);
            }

            // Forcer le rafraîchissement du mapping
            _lastContractRefresh = DateTime.MinValue;
            RefreshContractMapping();

            Console.WriteLine($"✅ {allKeys.Count} entrées supprimées du cache");
            return true;
        }

        /// <summary>
        /// Récupère la liste des villes en cache
        /// </summary>
        public string[] GetCachedCities()
        {
            var cities = _cache
                .Where(kvp => kvp.Key.StartsWith("JCDecaux-Stations-"))
                .Select(kvp => kvp.Key.Replace("JCDecaux-Stations-", ""))
                .ToArray();

            Console.WriteLine($"📋 Villes en cache : {string.Join(", ", cities)}");
            return cities;
        }
    }
}