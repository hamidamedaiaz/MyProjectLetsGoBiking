using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using ProxyCache.Models;

namespace ProxyCache.Services
{
    /// <summary>
    /// Service pour interagir avec l'API JCDecaux
    /// </summary>
    public class JCDecauxService
    {
        private const string ApiKey = "4ffffd09ca3de7e586d3f46bebbd9a8a7f98191f";

        /// <summary>
        /// ✅ NOUVEAU : Récupère la liste de tous les contrats disponibles
        /// </summary>
        public Dictionary<string, string> GetAvailableContracts()
        {
            string url = $"https://api.jcdecaux.com/vls/v3/contracts?apiKey={ApiKey}";

            Console.WriteLine($"🌐 Récupération de la liste des contrats JCDecaux...");
            Console.WriteLine($"   URL : {url}");

            using (var client = new WebClient())
            {
                try
                {
                    client.Headers.Add("User-Agent", "ProxyCache/1.0");
                    string json = client.DownloadString(url);

                    if (string.IsNullOrWhiteSpace(json))
                    {
                        Console.WriteLine("⚠️ Aucune donnée reçue");
                        return new Dictionary<string, string>();
                    }

                    // Désérialiser la réponse
                    var contracts = JsonConvert.DeserializeObject<List<JObject>>(json);

                    if (contracts == null || contracts.Count == 0)
                    {
                        Console.WriteLine("⚠️ Aucun contrat trouvé");
                        return new Dictionary<string, string>();
                    }

                    // Créer un dictionnaire : nom commercial → nom de contrat
                    var contractMapping = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

                    foreach (var contract in contracts)
                    {
                        string contractName = contract["name"]?.ToString();
                        string commercialName = contract["commercial_name"]?.ToString();
                        string countryCode = contract["country_code"]?.ToString();
                        string cities = contract["cities"]?.ToString();

                        if (!string.IsNullOrWhiteSpace(contractName))
                        {
                            // Ajouter le nom de contrat officiel
                            contractMapping[contractName] = contractName;

                            // Ajouter le nom commercial si différent
                            if (!string.IsNullOrWhiteSpace(commercialName) && 
                                !string.Equals(contractName, commercialName, StringComparison.OrdinalIgnoreCase))
                            {
                                contractMapping[commercialName] = contractName;
                            }

                            // Ajouter les noms de villes si disponibles
                            if (!string.IsNullOrWhiteSpace(cities))
                            {
                                var cityList = cities.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                                foreach (var city in cityList)
                                {
                                    string cleanCity = city.Trim();
                                    if (!contractMapping.ContainsKey(cleanCity))
                                    {
                                        contractMapping[cleanCity] = contractName;
                                    }
                                }
                            }

                            Console.WriteLine($"   ✅ {contractName} ({commercialName}) - {countryCode}");
                        }
                    }

                    Console.WriteLine($"✅ {contracts.Count} contrats récupérés, {contractMapping.Count} mappings créés");
                    return contractMapping;
                }
                catch (WebException ex)
                {
                    Console.WriteLine($"❌ Erreur WebException : {ex.Message}");

                    if (ex.Response != null)
                    {
                        using (var reader = new StreamReader(ex.Response.GetResponseStream()))
                        {
                            string errorResponse = reader.ReadToEnd();
                            Console.WriteLine($"📄 Réponse d'erreur : {errorResponse}");
                        }
                    }

                    return new Dictionary<string, string>();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ Erreur inattendue : {ex.Message}");
                    return new Dictionary<string, string>();
                }
            }
        }

        /// <summary>
        /// ✅ MODIFIÉ : Récupère les stations (renommé pour correspondre à l'interface)
        /// </summary>
        public BikeStation[] GetStations(string contract)
        {
            string url = $"https://api.jcdecaux.com/vls/v1/stations?contract={contract}&apiKey={ApiKey}";

            Console.WriteLine($"🌐 Appel API JCDecaux : {url}");

            using (var client = new WebClient())
            {
                try
                {
                    client.Headers.Add("User-Agent", "ProxyCache/1.0");
                    string json = client.DownloadString(url);

                    if (string.IsNullOrWhiteSpace(json))
                    {
                        Console.WriteLine("⚠️ Aucune donnée reçue");
                        return new BikeStation[0];
                    }

                    var stations = JsonConvert.DeserializeObject<List<dynamic>>(json);

                    if (stations == null || stations.Count == 0)
                    {
                        Console.WriteLine("⚠️ Aucune station trouvée");
                        return new BikeStation[0];
                    }

                    // ✅ Conversion en tableau
                    var result = stations.Select(s => new BikeStation
                    {
                        Name = s.name,
                        AvailableBikes = (int)s.available_bikes,
                        BikeStands = (int)s.bike_stands,
                        Latitude = (double)s.position.lat,
                        Longitude = (double)s.position.lng
                    }).ToArray();

                    Console.WriteLine($"✅ {result.Length} stations récupérées");
                    return result;
                }
                catch (WebException ex)
                {
                    Console.WriteLine($"❌ Erreur WebException : {ex.Message}");

                    if (ex.Response != null)
                    {
                        using (var reader = new StreamReader(ex.Response.GetResponseStream()))
                        {
                            string errorResponse = reader.ReadToEnd();
                            Console.WriteLine($"📄 Réponse d'erreur : {errorResponse}");
                        }
                    }

                    return new BikeStation[0];
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ Erreur inattendue : {ex.Message}");
                    return new BikeStation[0];
                }
            }
        }
    }
}