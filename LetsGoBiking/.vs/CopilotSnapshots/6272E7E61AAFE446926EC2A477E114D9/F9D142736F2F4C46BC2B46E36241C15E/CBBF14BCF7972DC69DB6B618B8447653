using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using ProxyCache.Models;

namespace ProxyCache.Services
{
    /// <summary>
    /// Service pour interagir avec l'API JCDecaux
    /// </summary>
    public class JCDecauxService
    {
        private const string ApiKey = "4ffffd09ca3de7e586d3f46bebbd9a8a7f98191f";

        /// <summary>
        /// ✅ NOUVEAU : Récupère la liste de tous les contrats disponibles
        /// </summary>
        public Dictionary<string, string> GetAvailableContracts()
        {
            string url = $"https://api.jcdecaux.com/vls/v3/contracts?apiKey={ApiKey}";

            Console.WriteLine($"🌐 Récupération de la liste des contrats JCDecaux...");
            Console.WriteLine($"   URL : {url}");

            using (var client = new WebClient())
            {
                try
                {
                    client.Headers.Add("User-Agent", "ProxyCache/1.0");
                    string json = client.DownloadString(url);

                    if (string.IsNullOrWhiteSpace(json))
                    {
                        Console.WriteLine("⚠️ Aucune donnée reçue");
                        return GetFallbackMapping();
                    }

                    // Désérialiser la réponse
                    var contracts = JsonConvert.DeserializeObject<List<ContractInfo>>(json);

                    if (contracts == null || contracts.Count == 0)
                    {
                        Console.WriteLine("⚠️ Aucun contrat trouvé");
                        return GetFallbackMapping();
                    }

                    // Créer un dictionnaire : nom commercial → nom de contrat
                    var contractMapping = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

                    foreach (var contract in contracts)
                    {
                        string contractName = contract.Name;
                        string commercialName = contract.CommercialName;
                        string countryCode = contract.CountryCode;
                        var cities = contract.Cities;

                        if (!string.IsNullOrWhiteSpace(contractName))
                        {
                            // Ajouter le nom de contrat officiel
                            contractMapping[contractName] = contractName;

                            // Ajouter le nom commercial si différent
                            if (!string.IsNullOrWhiteSpace(commercialName) && 
                                !string.Equals(contractName, commercialName, StringComparison.OrdinalIgnoreCase))
                            {
                                contractMapping[commercialName] = contractName;
                            }

                            // Ajouter les noms de villes si disponibles
                            if (cities != null && cities.Length > 0)
                            {
                                foreach (var city in cities)
                                {
                                    string cleanCity = city.Trim();
                                    if (!string.IsNullOrWhiteSpace(cleanCity) && !contractMapping.ContainsKey(cleanCity))
                                    {
                                        contractMapping[cleanCity] = contractName;
                                    }
                                }
                            }

                            Console.WriteLine($"   ✅ {contractName} ({commercialName ?? "N/A"}) - {countryCode ?? "N/A"} - {cities?.Length ?? 0} villes");
                        }
                    }

                    // ✅ Ajouter les mappings manuels pour les contrats manquants ou cas spéciaux
                    AddManualMappings(contractMapping);

                    Console.WriteLine($"✅ {contracts.Count} contrats récupérés, {contractMapping.Count} mappings créés");
                    return contractMapping;
                }
                catch (WebException ex)
                {
                    Console.WriteLine($"❌ Erreur WebException : {ex.Message}");

                    if (ex.Response != null)
                    {
                        using (var reader = new StreamReader(ex.Response.GetResponseStream()))
                        {
                            string errorResponse = reader.ReadToEnd();
                            Console.WriteLine($"📄 Réponse d'erreur : {errorResponse}");
                        }
                    }

                    return GetFallbackMapping();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ Erreur inattendue : {ex.Message}");
                    return GetFallbackMapping();
                }
            }
        }

        /// <summary>
        /// ✅ Ajoute des mappings manuels pour les contrats non couverts par l'API v3
        /// </summary>
        private void AddManualMappings(Dictionary<string, string> contractMapping)
        {
            // Mapping manuel pour Côte d'Azur (existe dans v1 mais pas dans v3)
            var manualMappings = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                // Côte d'Azur
                { "Nice", "Cote_d_Azur" },
                { "Antibes", "Cote_d_Azur" },
                { "Cannes", "Cote_d_Azur" },
                { "Grasse", "Cote_d_Azur" },
                { "Cote_d_Azur", "Cote_d_Azur" },
                { "Cote d'Azur", "Cote_d_Azur" },
                
                // Alias courants
                { "Brussels", "bruxelles" },
                { "Paris", "Paris" }
            };

            foreach (var mapping in manualMappings)
            {
                if (!contractMapping.ContainsKey(mapping.Key))
                {
                    contractMapping[mapping.Key] = mapping.Value;
                    Console.WriteLine($"   🔧 Mapping manuel ajouté : {mapping.Key} → {mapping.Value}");
                }
            }
        }

        /// <summary>
        /// ✅ Mapping de secours si l'API échoue
        /// </summary>
        private Dictionary<string, string> GetFallbackMapping()
        {
            Console.WriteLine("⚠️ Utilisation du mapping de secours");
            
            var fallback = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
            {
                // France
                { "Paris", "Paris" },
                { "Lyon", "Lyon" },
                { "Marseille", "Marseille" },
                { "Toulouse", "Toulouse" },
                { "Nice", "Cote_d_Azur" },
                { "Antibes", "Cote_d_Azur" },
                { "Cannes", "Cote_d_Azur" },
                { "Grasse", "Cote_d_Azur" },
                { "Cote_d_Azur", "Cote_d_Azur" },
                { "Nantes", "Nantes" },
                { "Rouen", "Rouen" },
                { "Nancy", "Nancy" },
                { "Amiens", "Amiens" },
                { "Mulhouse", "Mulhouse" },
                { "Créteil", "Creteil" },
                { "Creteil", "Creteil" },
                
                // International
                { "Bruxelles", "Bruxelles" },
                { "Brussels", "Bruxelles" },
                { "Luxembourg", "Luxembourg" },
                { "Dublin", "Dublin" }
            };

            return fallback;
        }

        /// <summary>
        /// ✅ MODIFIÉ : Récupère les stations (renommé pour correspondre à l'interface)
        /// </summary>
        public BikeStation[] GetStations(string contract)
        {
            string url = $"https://api.jcdecaux.com/vls/v1/stations?contract={contract}&apiKey={ApiKey}";

            Console.WriteLine($"🌐 Appel API JCDecaux : {url}");

            using (var client = new WebClient())
            {
                try
                {
                    client.Headers.Add("User-Agent", "ProxyCache/1.0");
                    string json = client.DownloadString(url);

                    if (string.IsNullOrWhiteSpace(json))
                    {
                        Console.WriteLine("⚠️ Aucune donnée reçue");
                        return new BikeStation[0];
                    }

                    var stations = JsonConvert.DeserializeObject<List<dynamic>>(json);

                    if (stations == null || stations.Count == 0)
                    {
                        Console.WriteLine("⚠️ Aucune station trouvée");
                        return new BikeStation[0];
                    }

                    // ✅ Conversion en tableau
                    var result = stations.Select(s => new BikeStation
                    {
                        Name = s.name,
                        AvailableBikes = (int)s.available_bikes,
                        BikeStands = (int)s.bike_stands,
                        Latitude = (double)s.position.lat,
                        Longitude = (double)s.position.lng
                    }).ToArray();

                    Console.WriteLine($"✅ {result.Length} stations récupérées");
                    return result;
                }
                catch (WebException ex)
                {
                    Console.WriteLine($"❌ Erreur WebException : {ex.Message}");

                    if (ex.Response != null)
                    {
                        using (var reader = new StreamReader(ex.Response.GetResponseStream()))
                        {
                            string errorResponse = reader.ReadToEnd();
                            Console.WriteLine($"📄 Réponse d'erreur : {errorResponse}");
                        }
                    }

                    return new BikeStation[0];
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ Erreur inattendue : {ex.Message}");
                    return new BikeStation[0];
                }
            }
        }

        /// <summary>
        /// Classe pour désérialiser les contrats de l'API v3
        /// </summary>
        private class ContractInfo
        {
            [JsonProperty("name")]
            public string Name { get; set; }

            [JsonProperty("commercial_name")]
            public string CommercialName { get; set; }

            [JsonProperty("cities")]
            public string[] Cities { get; set; }

            [JsonProperty("country_code")]
            public string CountryCode { get; set; }
        }
    }
}